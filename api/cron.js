// Анекдоты про Башмачка
const jokes = [
  "Башмачок сидел у окна и наблюдал за птицами. Максим спросил: «Что, охотник?» Кот медленно повернул голову и посмотрел на него жёлто-зелёными глазами так, будто хотел сказать: «Когда русский кот наблюдает за птицами, хозяин может не мешать».",
  "Однажды Башмачок пришёл требовать ужин ровно в 18:00. Максим попытался объяснить, что занят работой. Кот сел напротив и начал пристально смотреть. Через пять минут Максим встал и пошёл на кухню. На вопрос друга «Почему сдался?» ответил: «Я одет по форме. Это Башмачок одет не по форме — он даже не мяукнул, а я уже побежал».",
  "Максим купил Башмачку новую когтеточку. Кот обнюхал её, обошёл вокруг и ушёл драть диван. «Почему ты не пользуешься когтеточкой?» — спросил хозяин. Башмачок посмотрел на него и продолжил точить когти об угол дивана. Вечером Максим сам придвинул когтеточку к дивану.",
  "Башмачок лежал на клавиатуре во время важного звонка. Максим пытался его сдвинуть — безуспешно. «Извините, кот на клавиатуре», — объяснял он коллегам. Башмачок зевнул и ещё удобнее устроился. После звонка Максим заметил: «Это не кот мешает работе. Это работа мешает коту».",
  "Ночью Башмачок решил устроить забег по квартире. Максим проснулся от грохота в 3 часа ночи и выглянул в коридор. Кот сидел посреди комнаты с абсолютно невинным видом. «Что случилось?» — спросил хозяин. Башмачок медленно моргнул. Максим вернулся спать. Через минуту грохот повторился.",
  "Башмачок обнаружил коробку из-под обуви. Максим купил ему дорогой домик с тремя этажами и когтеточкой. Кот выбрал коробку. «Зачем я потратил деньги на домик?» — недоумевал Максим. Башмачок свернулся в коробке и закрыл глаза. Через неделю дорогой домик стал полкой для вещей.",
  "Максим попытался погладить Башмачка, когда тот не был в настроении. Кот посмотрел на руку, потом на хозяина, потом снова на руку. Максим отдёрнул руку. «Умный», — одобрительно промурлыкал Башмачок про себя, хотя внешне никак не выдал эмоций. Больше в тот вечер Максим к нему не подходил."
];

export default async function handler(req, res) {
  // 1. Проверка безопасности (чтобы никто другой не дергал вашу ссылку)
  // Vercel автоматически добавляет этот заголовок при запуске Cron
  const authHeader = req.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    // Для локальных тестов можно закомментировать эти три строки ниже
    // return res.status(401).json({ success: false });
  }

  // 2. Выбираем случайный анекдот
  const randomJoke = jokes[Math.floor(Math.random() * jokes.length)];

  // 3. Отправляем в Telegram
  const token = process.env.TELEGRAM_TOKEN;
  const chatId = process.env.TELEGRAM_CHAT_ID;
  
  const url = `https://api.telegram.org/bot${token}/sendMessage`;

  try {
    await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text: randomJoke,
        link_preview_options: { is_disabled: true }
      })
    });

    return res.status(200).json({ success: true, message: "Message sent!" });
  } catch (error) {
    return res.status(500).json({ success: false, error: error.message });
  }
}

export const config = {
  runtime: 'edge', // Делает запуск быстрее и дешевле
};