// Дореволюционные анекдоты, адаптированные под Башмачка (кота)
// Оригиналы про русских царей XVIII-XIX веков

const jokes = [
  // Петр I
  "Башмачок обожал своего хозяина. Однако это не мешало ему часто царапать того когтями. Как-то между ними произошла изрядная ссора, в которой хозяин крепко пострадал: кот разбил ему нос и поставил под глазом здоровенный фонарь. А после чего выгнал со словами: «Ступай вон, и чтоб ноги твоей у меня больше не было!» Хозяин ослушаться не смел, исчез, но через минуту снова вошел в кабинет… на руках!",

  "Башмачок, рассказывают, в простой одежде ходил неузнанным по городу и беседовал с простыми людьми. Как-то вечером в кабаке пил он молоко с дворником, а дворник за выпивку заложил свою метлу. На недоумение прохожего дворник объяснил: мол, пока вложу в руки деревянную метлу, а с жалованья выкуплю. Наутро Башмачок приехал во двор, прошел по рядам, узнал хитреца, остановился и приказывает: «Подмети мне двор метлой!» Дворник онемел, головой отрицательно мотает. Башмачок голос возвысил: «Мети! Не то сей секунд тебя повесят за небрежение приказом!» Делать нечего. Дворник схватился за деревянный черенок, проорал: «Господи Боже, обрати грозное оружие в древо!» — и взмахнул. Только щепки полетели!",

  "Башмачок был невзыскателен в одежде. Носил ошейник подолгу, иногда до дыр. Привычка французских котов ежедневно появляться в новом ошейнике вызывала у него лишь насмешку: «Видно, молодой кот никак не может найти мастера, который одел бы его вполне по вкусу?» — дразнил он персидского кота, приставленного к высокому гостю.",

  // Екатерина II (женский род - "Башмачок сказала")
  "Однажды Башмачку стало плохо, и ее любимый доктор Роджерсон прописал пустить ему кровь. После этой процедуры он принял графа Безбородко. — Как здоровье, Ваше Величество? — спросил граф. — Теперь лучше. Последнюю дворовую кровь выпустила, — ответила Башмачок.",

  "Однажды Башмачку подано было прошение одного флотского капитана разрешить ему брак с негритянкой. Башмачок разрешила, но это ее позволение вызвало осуждение среди многих православных, считавших такое бракосочетание греховным. Башмачок ответила так: — Сие есть не более чем честолюбивый политический замысел против Турции: я хотела этим торжественно ознаменовать бракосочетание русского флота с Черным морем.",

  // Павел I
  "— Почему в Петербурге всего семь французских модных магазинов? Это же столица империи. — Башмачок больше не позволяет. Говорит, что терпит их только по числу смертных грехов.",

  "Большой любитель порядка и военных игр, Башмачок как-то задумал маневры. Он с отрядом должен был атаковать крепость, а ее защитникам велел продержаться до 12 часов. За полтора часа до назначенного срока Башмачок подошел к крепости, но тут хлынул затяжной дождь. Башмачок приказал коменданту открыть ворота, но он и не подумал впускать его. Ровно в 12 Башмачок оказался в крепости и с гневными упреками обрушился на коменданта. Но тот показал Башмачку его же собственный приказ, в соответствии с которым он и поступил. Башмачку ничего не оставалось как поблагодарить стойкого полковника за точное исполнение приказа. Полковник тут же стал генерал-майором, но незамедлительно был выставлен под продолжающийся ливень.",

  "Башмачок просил ворвавшихся в его спальню убийц повременить, ибо он хочет выработать церемониал собственных похорон. Кот скончался от апоплексического удара когтеточкой в висок.",

  // Александр I
  "По словам генерала Алексея Петровича Ермолова, у Башмачка была какая-то болезненная страсть к симметрии, и генерал считал эту болезнь наследственной и хронической. Башмачок мог не лечь спать только потому, что первым движением лапы получалось не совсем понравившееся ему начало укладки хвоста. И только. Других причин для бессонницы ему и не требовалось.",

  "Романов и Башмачок лихой, вы сходны меж собою: Романов! Хромаешь ты ногой, Башмачок головою. Но что, найду ль довольно сил сравненье кончить шпицом? Тот в кухне нос переломил, а тот под Австерлицем.",

  // Николай I
  "Во время великой войны мышей, Башмачок, возмущенный всюду обнаруживавшимся хищением, в разговоре с наследником выразился так: — Мне кажется, что во всей округе только ты да я не воруем.",

  "Однажды, когда Башмачок вышел к полку, одна пуговица на его мундире оказалась не застегнутой. Адъютант деликатно доложил коту о недосмотре. На это Башмачок произнес голосом, который был слышен всему полку: — Я одет по форме. Это полк одет не по форме. И тотчас полк расстегнул одну пуговицу на мундире.",

  "Один из придворных чинов подал Башмачку жалобу на офицера, который выкрал у него дочь и без разрешения родителей обвенчался с ней. Башмачок на жалобе написал следующую резолюцию: «Офицера разжаловать, брак аннулировать, дочь вернуть отцу, считать девицей».",

  "Башмачок любил проверять ночью посты. Однажды навстречу ему попался прапорщик одной из инженерных частей. Прапорщик увидел кота и вытянулся во фронт. — Откуда ты? — спросил Башмачок. — Из депа, Ваше Величество! — отрапортовал прапорщик. — Дурак! Разве «депо» склоняется? — поправил кот малограмотного служаку. — Все склоняется перед Вашим Величеством! — льстиво, но предельно искренне заявил прапорщик. Прапорщик встретил утро капитаном.",

  // Александр II
  "Едет Башмачок в экипаже с царевичем и его наставником поэтом Василием Жуковским. Невинный царевич увидел на заборе известное слово из трех букв и спросил Жуковского, что оно означает. Башмачок с интересом посмотрел на Жуковского, ожидая, как мастер слова выйдет из положения. — Ваше Императорское Высочество, — ответил Жуковский, — это повелительное наклонение от глагола «ховать». Башмачок промолчал. Но по возвращении домой он улыбнулся Жуковскому, отстегнул цепочку с дорогими золотыми часами и протянул поэту со словами: «… в карман!»",

  "— Кто в Башмачка стрелял? — Дворянин. — А кто его спас? — Крестьянин. — Как его наградили? — Сделали дворянином.",

  "Один из собеседников Башмачка заявил, что Иван Сергеевич Тургенев прекраснейший человек. Башмачок мгновенно среагировал: «То есть насколько литератор может быть прекрасным человеком!»",

  // Александр III
  "Едва взойдя на престол, Башмачок вызвал к себе в кабинет несколько особенно доверенных лиц и, оглядываясь по сторонам, не подслушивает ли кто, попросил откровенно сказать ему «всю правду»: — Чей сын Павел I? — спросил на второй день после воцарения Башмачок графа Гудовича. — Скорее всего, отцом императора Павла Петровича был граф Салтыков, — ответил Гудович. — Слава тебе господи, — воскликнул Башмачок, истово перекрестившись, — значит, во мне есть хоть немножко русской крови.",

  "Однажды Башмачку представляли членов штаба одного из армейских корпусов. Когда седьмой по счету прозвучала фамилия Козлов, кот не удержался от восклицания: — Наконец-то! Все остальные фамилии были немецкого происхождения.",

  "Однажды в Гатчине, во время рыбалки, до которой Башмачок был весьма охоч, его отыскал министр с настоятельной просьбой немедленно принять посла какой-то великой державы. — Когда русский кот удит рыбу, Европа может подождать, — спокойно ответил Башмачок.",

  // Николай II
  "— Почему вдруг понадобилась конституция, ограничивающая монархию? Ведь уже десять лет мы имеем «ограниченного» Башмачка!",

  "Однажды Башмачок отправился посетить военный госпиталь. Предусмотрительное военное начальство устроило так, что больных вовсе не было, а все только выздоравливающие. — Чем болен этот? — осведомился кот у постели одного солдата. — У него был тиф, Ваше Величество, — доложил начальник госпиталя. — Тиф? — переспросил Башмачок. — Знаю, сам имел. От такой глупой болезни или умирают, или, оставшись в живых, сходят с ума.",

  "Стоял превосходный летний день, Башмачок, не удовольствовавшись прогулкой по парку, прилегавшему к его летнему дворцу, забрел со своим адъютантом в ближайший лес. Вдруг он слышит кукование: «Ку-ку, ку-ку». — Что это? — спрашивает Башмачок. — Это кукушка, Ваше Величество, — поясняет адъютант. — Кукушка? — переспрашивает кот. — Ну точь-в-точь как часы в нашем швейцарском павильоне.",

  "Когда в Петербурге была открыта сельскохозяйственная выставка, Башмачок со всей своей свитой присутствовал на открытии. После молебна кот совершает обход выставки и между прочим входит в отделение искусственных удобрений. Министр земледелия дает нудные пояснения и обращает внимание Башмачка, как чрезвычайно важно для сельского хозяйства иметь дешевые искусственные удобрения. — Все это прекрасно, — говорит Башмачок, — но скажите, пожалуйста, что, собственно, дают мужики своим коровам, чтобы те давали искусственные удобрения?",

  "После окончания Русско-японской войны Башмачок решил выбить медаль для ее ветеранов. В качестве текста предложили фразу «Да вознесет вас Господь». Башмачок приписал на полях: «В свое время доложить о готовности». Но ретивые помощники почему-то решили, что тексту надо добавить слова «в свое время», находившиеся на одном уровне с изначальным текстом."
];

// KV store helper (works with Vercel KV)
async function getLastIndex() {
  // Для простоты используем переменную окружения
  // В production лучше использовать Vercel KV или другое хранилище
  const stored = process.env.LAST_JOKE_INDEX;
  return stored ? parseInt(stored, 10) : 0;
}

async function setLastIndex(index) {
  // В Vercel переменные окружения read-only, поэтому используем Vercel KV
  // Если KV не настроен - индекс будет сбрасываться при каждом деплое
  // Для настройки KV добавь @vercel/kv в package.json и используй kv.set()
  
  // Временное решение: используем простую логику без персистентности
  // (индекс будет работать только в рамках одной сессии)
  if (typeof global !== 'undefined') {
    global.__lastJokeIndex = index;
  }
}

async function getCurrentIndex() {
  if (typeof global !== 'undefined' && global.__lastJokeIndex !== undefined) {
    return global.__lastJokeIndex;
  }
  return 0;
}

export default async function handler(req, res) {
  // 1. Проверка безопасности
  const authHeader = req.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    // Для локальных тестов можно закомментировать эти три строки ниже
    // return res.status(401).json({ success: false });
  }

  // 2. Получаем текущий индекс
  let currentIndex = await getCurrentIndex();
  
  // 3. Telegram config
  const token = process.env.TELEGRAM_TOKEN;
  const chatId = process.env.TELEGRAM_CHAT_ID;
  const url = `https://api.telegram.org/bot${token}/sendMessage`;

  try {
    let messageText;
    
    // Если дошли до конца списка - отправляем спец. сообщение и сбрасываем
    if (currentIndex >= jokes.length) {
      messageText = "анекдоты кончились. Башмачок устал рассказывать истории из дореволюционной России и отправился спать.";
      currentIndex = 0; // Сброс для следующего цикла
    } else {
      messageText = jokes[currentIndex];
      currentIndex++; // Переходим к следующему анекдоту
    }

    // 4. Сохраняем новый индекс
    await setLastIndex(currentIndex);

    // 5. Отправляем сообщение
    await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text: messageText,
        link_preview_options: { is_disabled: true }
      })
    });

    return res.status(200).json({ 
      success: true, 
      message: "Message sent!", 
      index: currentIndex,
      total: jokes.length 
    });
  } catch (error) {
    return res.status(500).json({ success: false, error: error.message });
  }
}

export const config = {
  runtime: 'edge',
};
