// Анекдоты про Башмачка (адаптированные из дореволюционных)
const jokes = [
  "Башмачок обожал своего хозяина. Однако это не мешало ему часто царапать того когтями. Как-то между ними произошла изрядная ссора, в которой хозяин крепко пострадал: кот разбил ему нос и поставил под глазом здоровенный фонарь. А после чего выгнал со словами: «Ступай вон, и чтоб ноги твоей у меня больше не было!» Хозяин ослушаться не смел, исчез, но через минуту снова вошел в кабинет… на руках!",
  "Башмачок, рассказывают, в простой одежде ходил неузнанным по городу и беседовал с простыми людьми. Как-то вечером в кабаке пил он молоко с дворником, а дворник за выпивку заложил свою метлу. На недоумение прохожего дворник объяснил: мол, пока вложу в руки деревянную метлу, а с жалованья выкуплю. Наутро Башмачок приехал во двор, прошел по рядам, узнал хитреца, остановился и приказывает: «Подмети мне двор метлой!» Дворник онемел, головой отрицательно мотает. Башмачок голос возвысил: «Мети! Не то сей секунд тебя повесят за небрежение приказом!» Делать нечего. Дворник схватился за деревянный черенок, проорал: «Господи Боже, обрати грозное оружие в древо!» — и взмахнул. Только щепки полетели!",
  "Башмачок был невзыскателен в одежде. Носил ошейник подолгу, иногда до дыр. Привычка французских котов ежедневно появляться в новом ошейнике вызывала у него лишь насмешку: «Видно, молодой кот никак не может найти мастера, который одел бы его вполне по вкусу?» — дразнил он персидского кота, приставленного к высокому гостю.",
  "Однажды Башмачку стало плохо, и его любимый доктор Роджерсон прописал пустить ему кровь. После этой процедуры он принял графа Безбородко. — Как здоровье, Ваше Величество? — спросил граф. — Теперь лучше. Последнюю дворовую кровь выпустила, — ответил Башмачок.",
  "Башмачок просил ворвавшихся в его спальню убийц повременить, ибо он хочет выработать церемониал собственных похорон. Кот скончался от апоплексического удара когтеточкой в висок.",
  "По словам генерала Алексея Петровича Ермолова, у Башмачка была какая-то болезненная страсть к симметрии, и генерал считал эту болезнь наследственной и хронической. Башмачок мог не лечь спать только потому, что первым движением лапы получалось не совсем понравившееся ему начало укладки хвоста. И только. Других причин для бессонницы ему и не требовалось.",
  "Во время великой войны мышей, Башмачок, возмущенный всюду обнаруживавшимся хищением, в разговоре с наследником выразился так: — Мне кажется, что во всей округе только ты да я не воруем.",
  "Однажды, когда Башмачок вышел к полку, одна пуговица на его мундире оказалась не застегнутой. Адъютант деликатно доложил коту о недосмотре. На это Башмачок произнес голосом, который был слышен всему полку: — Я одет по форме. Это полк одет не по форме. И тотчас полк расстегнул одну пуговицу на мундире."
];

export default async function handler(req, res) {
  // 1. Проверка безопасности (чтобы никто другой не дергал вашу ссылку)
  // Vercel автоматически добавляет этот заголовок при запуске Cron
  const authHeader = req.headers.get('authorization');
  if (authHeader !== `Bearer ${process.env.CRON_SECRET}`) {
    // Для локальных тестов можно закомментировать эти три строки ниже
    // return res.status(401).json({ success: false });
  }

  // 2. Выбираем случайный анекдот
  const randomJoke = jokes[Math.floor(Math.random() * jokes.length)];

  // 3. Отправляем в Telegram
  const token = process.env.TELEGRAM_TOKEN;
  const chatId = process.env.TELEGRAM_CHAT_ID;
  
  const url = `https://api.telegram.org/bot${token}/sendMessage`;

  try {
    await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        chat_id: chatId,
        text: randomJoke,
        link_preview_options: { is_disabled: true }
      })
    });

    return res.status(200).json({ success: true, message: "Message sent!" });
  } catch (error) {
    return res.status(500).json({ success: false, error: error.message });
  }
}

export const config = {
  runtime: 'edge', // Делает запуск быстрее и дешевле
};